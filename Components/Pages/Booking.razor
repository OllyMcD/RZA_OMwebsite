@page "/booking"
@using RZA_OMwebsite.Services
@using RZA_OMwebsite.Pages
@using MudBlazor
@inject AuthService AuthService
@inject PageService PageService
@inject NavigationManager NavigationManager


<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Style="background-color: #F3CA5F; padding: 2rem;">
    <MudPaper Class="pa-4 mx-auto" MaxWidth="600px" Elevation="3">
        <MudText Typo="Typo.h4" Align="Align.Center">Booking Page</MudText>
        <MudDivider Class="my-2" />

        @if (!AuthService.isLoggedIn)
        {
            <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Error">You must be logged in to access this page.</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => NavigationManager.NavigateTo("/"))">Go to Home</MudButton>
        }
        else
        {
            <MudForm @ref="bookingForm" Model="bookingModel">
                <MudTextField @bind-Value="bookingModel.Name" Label="Name" Required="true" />
                <br />
                <MudTextField @bind-Value="bookingModel.Email" Label="Email" Required="true" />
                <br />
                <MudTextField @bind-Value="bookingModel.Phone" Label="Phone Number" Required="true" />
                <br />
                <MudSelect @bind-Value="bookingModel.Tickets" Label="Number of Tickets" Required="true">
                    <MudSelectItem Value="1">1</MudSelectItem>
                    <MudSelectItem Value="2">2</MudSelectItem>
                    <MudSelectItem Value="3">3</MudSelectItem>
                    <MudSelectItem Value="4">4</MudSelectItem>
                    <MudSelectItem Value="5">5</MudSelectItem>
                </MudSelect>
                <br />
                <br />

                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitBooking">Submit Booking</MudButton>
            </MudForm>

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Class="my-2">@successMessage</MudAlert>
            }
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Class="my-2">@errorMessage</MudAlert>
            }
        }
    </MudPaper>
</MudContainer>

@code {
    private MudForm? bookingForm; // Make bookingForm nullable
    private BookingModel bookingModel = new BookingModel();
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private bool first = true;

    protected override async Task OnInitializedAsync()
    {
        if (!CheckLoginStatus())
        {
            NavigationManager.NavigateTo("/"); // Redirect to home if not logged in
        }
    }

    private bool CheckLoginStatus()
    {
        // Simulate login status; replace this with your actual logic
        return AuthService.isLoggedIn; // Check the login status
    }

    private void SubmitBooking()
    {
        if (bookingForm != null && bookingForm.IsValid)
        {
            // Simulate booking submission logic
            successMessage = "Your booking has been successfully submitted!";
            errorMessage = string.Empty;
            bookingModel = new BookingModel(); // Reset form
            NavigationManager.NavigateTo("/tickets");
        }
        else
        {
            errorMessage = "Please fill in all required fields.";
            successMessage = string.Empty;
        }
    }

    public class BookingModel
    {
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public int Tickets { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Get the current page URL (this can be adjusted depending on how you're tracking page URL)
            var currentPageUrl = NavigationManager.Uri.Substring(22);

            // Call the method to track the page view
            await PageService.TrackPageViewAsync(currentPageUrl);
            first = false;
        }
    }
}
